# Software Design Document (SDD)
# 靈閣 (Líng Gé)

> **最後更新**: 2026-01-30
> **版本**: 3.0.0

---

## 1. 專案概述

### 1.1 專案名稱與核心定位

**靈閣 (Líng Gé)**

> *「借他山之石，攻你心中玉」*
>
> *— 古蘿蔔遊戲 Global-soft Games*

透過 MCP 協議提供 **700+ 跨領域理論混搭** 的思維增強服務。

#### 核心玩法：複合理論混搭

靈閣不是「找專家問答案」，而是「用 A 領域的方法解 B 領域的題」。

**跨界才有火花：**

```
❌ 錯誤理解：「我要找前端專家幫我寫 React」
                → 這只是普通的技術諮詢

✅ 正確玩法（跨界混搭實例）：

1. 「敏捷開發」× 婚禮規劃
   → Sprint 迭代、MVP 思維、持續交付，讓籌備婚禮不再失控

2. 「方法演技」× 產品設計
   → 情感記憶、角色沉浸、感官回憶，設計出真正打動人心的體驗

3. 「遊戲設計」× 團隊激勵
   → 成就系統、進度回饋、隨機獎勵，把枯燥的 KPI 變成破關動力

4. 「馬斯克第一性原理」× 心理學 × 遊戲開發
   → 拆解玩家動機的本質、心理獎勵機制、從零重構遊戲循環

5. 「建築結構學」× 團隊組織
   → 承重牆概念分配核心職責、模組化設計避免單點故障

6. 「物理學」× 專案管理
   → 慣性定律理解變革阻力、力矩原理分配資源槓桿點
```

**700+ 理論 × 跨界混搭 = 489,300+ 種組合**

- 不是找答案，是找**新視角**
- 跳出原本的**思考框架**
- 用意想不到的角度**重新審視**問題

**這才是靈閣的正確打開方式。**

### 1.2 願景與背景

#### 核心洞察：思維觀念的價值

AI 能力再強，也只是工具。真正的差異化來自於：**用什麼思維方式使用 AI**。

```
同樣問 AI「幫我設計登入頁面」：

普通用戶的回應              ←  直接問
────────────────────────────────────────
通用的設計建議
標準的 UI 元件
沒有深度的回答

注入專家思維後的回應        ←  Fitts's Law + 認知負荷理論 + 完形心理學
────────────────────────────────────────
按鈕大小符合 Fitts's Law（觸控目標 44×44px）
認知負荷分析：減少表單欄位到必要項目
視覺群組遵循 Gestalt 接近原則
專業級的設計決策依據
```

**這就是靈閣的價值：讓每個人都能用專家的思維方式來使用 AI。**

#### 超級個體時代

我們正站在一個劃時代的轉折點：**超級個體時代**即將遍地開花。

```
過去                          現在                         未來
────────────────────────────────────────────────────────────────
個人能力有限               AI 輔助增強                 超級個體
需要團隊分工               一人可當十人用              一人即公司
專業需要多年累積           AI 補足專業缺口             人人皆智靈
```

在這個時代：
- 一個人 + AI = 過去一個團隊的產出
- 專業知識不再是門檻，而是**隨選即用的資源**
- 每個人都能成為「超級個體」，創造過去難以想像的價值

#### 為什麼需要靈閣？

當 AI Agent 成為超級個體的「靈魂夥伴」，問題來了：

```
❓ 專家的思維方式從哪裡來？
❓ 如何把這些專業觀念注入給 AI？
❓ 怎麼讓用戶用白話問，卻得到專業答案？
❓ 如何讓創作者分享自己的專業思維框架？
```

**靈閣就是答案。**

這是一座 **專家思維寶庫**：
- 🧠 收藏各領域專家的「思維框架」與「專業觀念」
- 🌐 開放創作者上傳，讓智慧共享（歌單經濟）
- 🎯 語意匹配：用戶說白話，系統找對應專業觀念
- 💫 觀念注入：自動用專業術語強化 AI 回應

#### 目標用戶

| 維度 | 設定 | 原因 |
|------|------|------|
| **TA** | All | 超級個體時代，人人都需要 AI 夥伴 |
| **年齡** | All | 從學生到長者，AI 不分年齡 |
| **背景** | All | 工程師、設計師、創業者、任何人 |

這不是給特定族群的工具，而是給**這個時代所有人**的基礎設施。

#### 時代的必然

這個願景聽起來前衛，但它不是遙遠的未來——**它正在發生**。

- Claude Code 讓開發者效率倍增
- AI 讓非專業者也能完成專業任務
- 超級個體正在各行各業崛起

靈閣不是創造趨勢，而是**為必然到來的時代建立基礎設施**。

### 1.3 專案目標
建立一個以 MCP (Model Context Protocol) 為基礎的專家思維分發平台。核心機制是「觀念注入」：將用戶的白話問題，透過語意匹配找到對應的專業概念，自動增強 AI 的回應深度。

### 1.4 核心價值
- 🧠 **觀念注入**：用戶說白話，AI 用專業術語回應
- 🔌 **MCP 整合**：AI 助手可透過 MCP 協議查詢、召喚智靈
- 📚 **專家思維庫**：收藏各領域的理論框架與專業知識
- 🎯 **語意匹配**：自動將模糊描述轉換為專業概念
- 🌐 **多平台支援**：支援 Claude Code、ChatGPT、Gemini 等（OAuth 認證）
- 👥 **創作者生態**：開放創作者上傳思維框架，市場決定價值（歌單經濟模式）

---

## 2. 系統架構

### 2.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Layer                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │   Web Client    │  │   Author        │  │   Web Admin                 │  │
│  │   (Port 3000)   │  │   Dashboard     │  │   (Port 3300)               │  │
│  │   使用者前端     │  │   (web-client)  │  │   管理後台前端（靜態）        │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────┬───────────────┘  │
│           │                    │                          │                  │
│           └────────────────────┼──────────────────────────┘                  │
│                                │                                             │
├────────────────────────────────┼─────────────────────────────────────────────┤
│                          Service Layer                                       │
│  ┌─────────────────────────────┴─────────────────────────────────────────┐  │
│  │                                                                        │  │
│  │  ┌───────────────────────────────────┐  ┌─────────────────────────┐   │  │
│  │  │   API Server (Port 3100)          │  │   MCP Server            │   │  │
│  │  │                                   │  │   (Port 3200)           │   │  │
│  │  │  • 用戶認證         • Admin API   │  │                         │   │  │
│  │  │  • 計費系統         • 平台統計     │  │  • MCP HTTP/SSE         │   │  │
│  │  │  • 額度管理         • 用戶管理     │  │  • list_agents          │   │  │
│  │  │  • Author 分潤     • 作者管理     │  │  • get_agent            │   │  │
│  │  │  • Agent 上傳      • 交易紀錄     │  │  • summon_agent         │   │  │
│  │  │  • PayPal 金流     • 分潤報表     │  │  • recommend            │   │  │
│  │  │                                   │  │  • get_preset           │   │  │
│  │  └────────────────┬──────────────────┘  └────────────┬────────────┘   │  │
│  │                   │                                   │                │  │
│  │                   └───────────────────────────────────┘                │  │
│  │                                                                        │  │
│  └────────────────────────────────┬───────────────────────────────────────┘  │
│                                   │                                          │
├───────────────────────────────────┼──────────────────────────────────────────┤
│                            Data Layer                                        │
│  ┌────────────────────────────────┴────────────────────────────────────┐    │
│  │                         MongoDB (ling-ge)                            │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │    │
│  │  │   users     │  │   apiKeys   │  │   transactions              │  │    │
│  │  │  用戶帳號    │  │  API 金鑰   │  │  交易紀錄                    │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │    │
│  │  │ authorEarnings│ │uploadedAgents│ │   summonLogs               │  │    │
│  │  │  作者收益     │  │  上傳的智靈  │  │  召喚紀錄                   │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                         File System                                  │    │
│  │  agents/                                                             │    │
│  │  ├── thinking/         (思維/理論型 Agent)                           │    │
│  │  ├── frontend/         (前端相關 Agent)                              │    │
│  │  ├── backend/          (後端相關 Agent)                              │    │
│  │  ├── game-dev/         (遊戲開發 Agent)                              │    │
│  │  ├── industrial/       (工業/系統 Agent)                             │    │
│  │  ├── firmware/         (韌體/嵌入式 Agent)                           │    │
│  │  └── quality/          (品質保證 Agent)                              │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.1.1 服務說明

| 服務 | Port | 說明 |
|------|------|------|
| **Web Client** | 3000 | 使用者前端：Agent 瀏覽、Author Dashboard |
| **API Server** | 3100 | 核心業務邏輯 + Admin API：用戶認證、計費、分潤、管理後台 |
| **MCP Server** | 3200 | MCP 協議服務：供 Claude Code 等 AI 工具使用 |
| **Web Admin** | 3300 | 管理後台前端（靜態網站，呼叫 API Server /admin/* 端點）|

### 2.1.2 混合 Agent 來源

系統採用混合 Agent 架構，支援兩種來源：

```
┌───────────────────────────────────────────────────────────────┐
│                    Agent 來源                                  │
├───────────────────────────────┬───────────────────────────────┤
│      本地檔案 (Official)       │      MongoDB (User-uploaded)  │
│  agents/*.md                  │  uploadedAgents Collection    │
├───────────────────────────────┼───────────────────────────────┤
│  • 33 個官方智靈               │  • 用戶上傳的智靈              │
│  • 檔案系統讀取                │  • 資料庫讀取                  │
│  • 無 author 欄位（系統內建）   │  • 有 author 欄位             │
│  • 不計入分潤                  │  • 每次召喚計算分潤            │
└───────────────────────────────┴───────────────────────────────┘
```

### 2.2 技術棧

| 層級 | 技術 | 用途 |
|------|------|------|
| Frontend | Vanilla TypeScript | 2D 列表介面（輕量化） |
| Frontend | Vite | 開發與建置工具 |
| Backend | Node.js + Express | API Server（含 Admin API）|
| Backend | Node.js + MCP SDK | MCP Server (HTTP/SSE Transport) |
| Database | MongoDB | 用戶、交易、分潤、上傳 Agent |
| Auth | API Key | 用戶驗證與用量控制 |
| Payment | PayPal API | 儲值金流（Sandbox/Live） |
| Storage | File System + MongoDB | 官方 Agent (檔案) + 用戶上傳 Agent (DB) |
| Deployment | **GCP Cloud Run** | 服務部署（按用量計費） |

### 2.3 架構決策記錄 (ADR)

#### ADR-001: 改用 2D 列表介面（2024-12）
- **決策**：放棄 Three.js 3D 書架，改用 2D 卡片列表
- **原因**：3D 座標系統問題耗時過多，2D 更快上線驗證市場
- **影響**：移除 three.js、gsap 依賴，減少打包體積

#### ADR-002: 採用遠端 MCP Server 架構（2024-12）
- **決策**：MCP Server 部署於雲端，用戶透過 API Key 存取
- **原因**：
  1. 保護 Agent 智慧財產（內容不外流）
  2. 可追蹤用量、控制額度
  3. 隨時更新 Agent，用戶自動獲得最新版
  4. 便於實作付費機制
- **架構**：
  ```
  用戶 Claude Code → 遠端 MCP Server (GCP) → 驗證 API Key → 回傳 Agent
  ```

#### ADR-003: 選擇 GCP Cloud Run 部署（2024-12）
- **決策**：使用 GCP Cloud Run 而非 AWS/Vercel
- **原因**：
  1. 免費額度高（每月 200 萬次請求）
  2. 支援 HTTP/SSE，適合 MCP 協議
  3. 自動擴展，無流量時不收費
  4. 部署簡單（Docker container）

#### ADR-004: 英文優先的國際化策略（2024-12）
- **決策**：所有用戶面向的內容以英文為主要語言
- **原因**：
  1. 定位為國際級 AI 工具平台，吸引全球用戶
  2. 英文介面提升專業感與信任度，增加付費意願
  3. AI/MCP 生態系以英語為主流
  4. 後續可加入多語言支援（i18n）
- **實施範圍**：
  - Web 介面：英文為主，Agent 名稱保留雙語
  - API 回應：全英文
  - Agent 內容：英文 system prompt
  - 錯誤訊息：英文
  - 文件：英文（README、API docs）
- **保留中文**：
  - 內部開發文件（SDD）
  - 程式碼註解（團隊溝通）
  - 台灣市場特定行銷素材

---

## 3. MCP Server 設計

### 3.1 核心流程：觀念注入

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            觀念注入流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   用戶：「介面很亂，不知道怎麼改」                                             │
│          │                                                                   │
│          ▼                                                                   │
│   ┌────────────┐                                                            │
│   │    ask     │  分析問題，推薦 5 個候選智靈                                  │
│   └─────┬──────┘                                                            │
│         │ 返回候選：UI Psychology Expert, Color Design Expert, ...            │
│         ▼                                                                   │
│   ┌────────────────┐                                                        │
│   │  summon_agent  │  AI 選擇最適合的智靈，傳入 user_query                    │
│   └───────┬────────┘                                                        │
│           │                                                                 │
│           ▼                                                                 │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │  觀念注入結果 (concept_injection)                                    │    │
│   │                                                                     │    │
│   │  enriched_context:                                                  │    │
│   │    「介面很亂」→ 認知負荷過高、違反 Gestalt 接近原則                    │    │
│   │                                                                     │    │
│   │  applied_theories:                                                  │    │
│   │    - 認知負荷理論 Cognitive Load Theory                               │    │
│   │    - 完形心理學 Gestalt Psychology                                    │    │
│   │    - Miller's Law (7±2)                                             │    │
│   │                                                                     │    │
│   │  guidance:                                                          │    │
│   │    運用這些理論框架分析介面問題，給出專業建議                            │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│           │                                                                 │
│           ▼                                                                 │
│   AI 以專業視角回答：                                                         │
│   「根據認知負荷理論，你的介面問題可能是外部認知負荷過高...                     │
│    建議用 Gestalt 接近原則重新分組，將相關元素放在一起...                       │
│    根據 Miller's Law，導航項目控制在 5-7 個以內...」                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 MCP 工具概覽

靈閣透過 MCP (Model Context Protocol) 提供以下核心功能：

#### 主要工具

- **ask**：詢問問題，系統推薦適合的智靈（不消耗額度）
- **summon_agent**：召喚智靈並注入專業觀念（消耗額度）

#### 查詢工具

- **list_agents**：列出所有可用智靈，支援類別篩選
- **get_agent**：取得特定智靈的詳細資訊
- **get_preset**：取得預設智靈組合包
- **recommend_agents**：根據描述推薦適合的智靈

#### 帳號管理

- **get_balance**：查看額度餘額
- **set_mode**：切換額度使用模式（緣/魂）
- **get_usage_stats**：查看使用統計

### 3.3 觀念注入機制

當使用者召喚智靈時，系統會：

1. **語意分析**：解析用戶問題中的關鍵概念
2. **理論匹配**：從智靈的專業理論庫中找出相關理論
3. **術語轉換**：將通俗問題轉換為專業術語
4. **脈絡建立**：提供該領域的思考框架與指引

**範例：**
```
用戶問題：「介面很亂，怎麼改善？」
召喚：design-thinking-expert（設計思考智靈）

觀念注入結果：
- 專業術語：「資訊架構混亂」→「視覺層級不清」
- 應用理論：格式塔原理、資訊架構理論
- 思考框架：同理心觀察 → 定義問題 → 發想解法 → 原型測試
```

---

## 4. Web 介面設計

> **注意**：原計畫使用 Three.js 3D 書架介面，但因開發效率考量已改為 2D 卡片列表（見 ADR-001）。

### 4.1 頁面結構

```
┌─────────────────────────────────────────────────────────────────┐
│  Web Frontend (Port 3000)                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  index.html (入口頁)                                             │
│  ├── Hero Section：靈閣品牌展示                                  │
│  ├── 「何為靈閣」：三個核心價值卡片                               │
│  ├── 「兩種身份」：使用者 / 創作者                                │
│  ├── 「如何運作」：MCP 設定說明                                   │
│  ├── 「教學影片」：Screen Studio 教學                             │
│  ├── 「創作者經濟」：90/10 分潤說明                               │
│  └── 「知識領域」：類別標籤展示                                   │
│                                                                  │
│  explore.html (探索頁)                                           │
│  ├── 類別篩選器                                                  │
│  ├── 智靈卡片列表                                                │
│  ├── 登入 Modal (OAuth + API Key)                                │
│  └── 智靈詳情 Modal                                              │
│                                                                  │
│  dashboard.html (創作者後台)                                     │
│  ├── 帳號資訊（雙額度：緣/魂）                                    │
│  ├── API Key 管理                                                │
│  ├── OAuth 帳號管理                                               │
│  ├── MCP 設定指南（Claude Code / ChatGPT / Gemini）              │
│  ├── 使用統計                                                    │
│  ├── 上傳智靈表單                                                │
│  └── Custom Instructions 設定                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 視覺設計

**設計風格**：東方神秘 + 宇宙深邃

| 元素 | 說明 |
|------|------|
| **主色調** | 金色 `#e8d5a3`（品牌色）、紫色 `#7c5cbf`（強調色） |
| **背景** | 深空黑 `#0a0a12` + 星辰粒子效果 |
| **字體** | 馬善政（品牌展示）、思源宋體（標題）、思源黑體（內文） |
| **動效** | 頁面轉場淡入淡出、滑鼠星辰粒子追蹤、卡片懸停上浮 |

### 4.3 智靈卡片設計

```
┌─────────────────────────────────────┐
│  🧠                                  │
│  介面心理學智靈                       │
│  UI Psychology Expert                │
│                                      │
│  認知負荷理論、完形心理學、            │
│  Fitts's Law、Hick's Law            │
│                                      │
│  #frontend  #psychology  #UX        │
│                                      │
│  ────────────────────────────────   │
│  👤 Global-soft Games    ⚡ sonnet   │
└─────────────────────────────────────┘
```

### 4.4 雙額度系統 UI

```
┌─────────────────────────────────────┐
│  Your Balance                        │
│                                      │
│  ┌───────────┐  ┌───────────┐       │
│  │  ☯ 緣     │  │  魂 🔥    │       │
│  │   100     │  │    50     │       │
│  │  credits  │  │  credits  │       │
│  └───────────┘  └───────────┘       │
│                                      │
│  Current Mode: [ 緣模式 ▼ ]          │
│                                      │
│  緣模式：免費額度，用完需儲值          │
│  魂模式：付費額度，支持創作者          │
└─────────────────────────────────────┘
```

### 4.5 類別配色

| 類別 | 顏色 | 色碼 |
|------|------|------|
| thinking | 深藍色 | `#1E3A5F` |
| frontend | 橙色 | `#E67E22` |
| backend | 綠色 | `#27AE60` |
| game-dev | 紫色 | `#8E44AD` |
| industrial | 灰色 | `#5D6D7E` |
| firmware | 棕色 | `#8B4513` |
| quality | 紅色 | `#C0392B` |

---

## 5. 核心概念與資料結構

> **詳細實作細節**：請參閱內部文件 `internal_docs/SDD_INTERNAL.md`（團隊成員專用）

### 5.1 智靈（Agent）

智靈是靈閣的核心單元，包含：

**基本屬性：**
- 名稱與描述
- 專業領域類別（思維理論、前端、後端、遊戲開發等）
- 結合的理論框架
- 觸發關鍵字

**運作機制：**
- 透過語意匹配自動選擇適合的智靈
- 注入專業思維到 AI 的 System Prompt
- 支援複合理論混搭（多個智靈組合）

**來源：**
- 官方智靈（700+ 個預建智靈）
- 用戶上傳智靈（創作者經濟）

### 5.2 使用者系統

**雙額度機制：**
- **緣額度**：免費額度，註冊即送 100 次
- **魂額度**：付費額度，透過 PayPal 儲值

**兩種身份：**
- **使用者（Summoner）**：召喚智靈完成任務
- **創作者（Author）**：上傳智靈獲得分潤（90%）

### 5.3 資料持久化

靈閣使用 MongoDB 儲存：
- 使用者帳號與額度
- 智靈召喚記錄
- 交易與分潤記錄
- OAuth 認證資訊

**混合 Agent 來源：**
- 官方智靈：檔案系統（Markdown 格式）
- 用戶智靈：MongoDB 資料庫

---

## 6. 認證與安全

### 6.1 OAuth 2.0 認證

靈閣採用 **OAuth 2.0** 標準協議，確保安全性：

**使用者視角：**
1. 在 ChatGPT/Claude Code 中設定 MCP 連線
2. 選擇 OAuth 認證方式
3. 在瀏覽器中登入靈閣（Email + TOTP 雙重認證）
4. 授權完成，MCP 自動連線

**安全優勢：**
- ✅ 不洩漏密碼給第三方應用
- ✅ Token 加密儲存且定期過期
- ✅ 可隨時撤銷授權
- ✅ HTTPS 全程加密通訊

**詳細教學：** [OAUTH_FLOW.md](OAUTH_FLOW.md)

### 6.2 雙重認證 (TOTP)

所有帳號都需要設定 TOTP (Time-based One-Time Password)：

- 使用 Google Authenticator、Authy 等驗證器 App
- 登入時需要輸入 6 位數驗證碼
- 即使密碼洩漏也無法登入

---

## 7. 公開 API 端點

### 7.1 無需認證的公開端點

| Endpoint | 說明 |
|----------|------|
| `GET /api/public-config` | 取得公開設定（計費、分潤比例） |
| `GET /api/agents` | 列出所有可用智靈 |
| `GET /api/agents/{id}` | 取得特定智靈資訊 |
| `GET /health` | 健康檢查 |

**範例：取得公開設定**

```bash
curl https://api.lingge.app/api/public-config
```

```json
{
  "freeCredits": 100,
  "pricePerSummon": 0.001,
  "authorShare": 0.9,
  "platformShare": 0.1,
  "topupEnabled": true
}
```

### 7.2 觀念注入機制

召喚智靈時，系統會自動進行「觀念注入」：

**流程：**
1. 使用者提問：「介面很亂，不知道怎麼改」
2. 系統語意匹配智靈（如「UI 心理學智靈」）
3. 注入專業理論到 System Prompt：
   - 認知負荷理論
   - 完形心理學
   - Miller's Law (7±2)
4. AI 根據專業框架回應

這就是靈閣的核心價值：**讓 AI 用專家的思維框架來回應**。

---

## 7. 檔案結構

```
ling-ge/
├── .env                             # 環境變數設定（計費、金流、DB）
├── SDD.md                           # 本文件
├── README.md                        # 專案說明
│
├── agents/                          # 官方 Agent 定義檔（33 個）
│   ├── thinking/                    # 思維/理論型 (6)
│   ├── frontend/                    # 前端開發 (4)
│   ├── backend/                     # 後端開發 (5)
│   ├── game-dev/                    # 遊戲開發 (5)
│   ├── industrial/                  # 工業系統 (3)
│   ├── firmware/                    # 韌體/嵌入式 (6)
│   └── quality/                     # 品質保證 (4)
│
├── api-server/                      # API Server (Port 3100)
│   ├── src/
│   │   ├── index.ts                 # 主程式
│   │   ├── config/
│   │   │   └── billing.ts           # 計費設定（從 .env 讀取）
│   │   └── db/
│   │       └── database.ts          # MongoDB 連線與操作
│   ├── package.json
│   └── tsconfig.json
│
├── mcp-server/                      # MCP Server (Port 3200)
│   ├── src/
│   │   ├── index.ts                 # MCP 主程式
│   │   ├── api-client.ts            # API Server 客戶端
│   │   └── tools/
│   │       ├── listAgents.ts
│   │       ├── getAgent.ts
│   │       ├── summonAgent.ts       # 召喚（扣額度 + 分潤）
│   │       ├── recommendAgents.ts
│   │       ├── getPreset.ts
│   │       ├── getBalance.ts
│   │       └── getUsageStats.ts
│   ├── package.json
│   └── tsconfig.json
│
├── web-admin/                       # Web Admin (Port 3300) - 管理後台前端
│   ├── src/
│   │   ├── main.ts                  # 主程式
│   │   └── style.css                # 樣式
│   ├── index.html
│   ├── package.json
│   └── vite.config.ts
│
├── web-client/                      # Web Client (Port 3000) - 使用者前端
│   ├── src/
│   │   ├── main.ts                  # 主程式
│   │   ├── dashboard.ts             # Author Dashboard
│   │   └── api/
│   │       ├── agentService.ts
│   │       └── dashboardService.ts
│   ├── index.html
│   ├── dashboard.html               # Author Dashboard 頁面
│   ├── package.json
│   └── vite.config.ts
│
├── presets/                         # 預設組合包
│   ├── game-project.json
│   ├── industrial-project.json
│   ├── fullstack-project.json
│   └── ...
│
└── package.json                     # 根目錄 package.json
```

---

## 8. 商業模式：歌單經濟

### 8.1 核心概念

靈閣採用「歌單經濟」模式：

```
┌─────────────────────────────────────────────────────────────┐
│                    創作者們                                  │
│            （任何人都可以上傳 Agent）                         │
└──────────┬──────────┬──────────┬──────────┬─────────────────┘
           │          │          │          │
           ▼          ▼          ▼          ▼
         📖        📖        📖        📖
           │          │          │          │
           └──────────┴────┬─────┴──────────┘
                           │ 上架
                           ▼
    ┌─────────────────────────────────────────────────────┐
    │              📚 靈閣平台                              │
    │                                                      │
    │   • 格式驗證                                         │
    │   • 垃圾過濾                                         │
    │   • 數據統計（下載量、評分）                          │
    │   • 智慧推薦（建議，非決定）                          │
    │                                                      │
    └──────────────────────┬──────────────────────────────┘
                           │
                           ▼
    ┌─────────────────────────────────────────────────────┐
    │                    用戶（超級個體）                   │
    │                                                      │
    │   「我要做 MMORPG」                                   │
    │            ↓                                         │
    │   平台建議：推薦 A、B、C，也建議考慮 D、E             │
    │            ↓                                         │
    │   用戶自行選擇 → 確認下載                            │
    │                                                      │
    │              💰 訂閱制 / 按下載付費                   │
    └──────────────────────┬──────────────────────────────┘
                           │
                           ▼
                   💸 分潤給創作者
```

### 8.2 平台定位：顧問而非保證

**核心原則：「建議你考慮，你來決定」**

| 定位 | 說明 |
|------|------|
| ❌ 錯誤 | 「幫你配好，直接用」→ 出事用戶怪平台 |
| ✅ 正確 | 「建議你考慮，你決定」→ 責任在用戶 |

**為什麼這樣設計？**

| | 歌單配錯 | Agent 配漏 |
|--|---------|-----------|
| 後果 | 聽到不喜歡的歌 | 程式有漏洞、專案出問題 |
| 損失 | 幾分鐘 | 可能很大 |
| 風險 | 極低 | 需要用戶自行把關 |

**平台是顧問，不是保證：**
- 推薦最適合的 Agent
- 提醒可能需要考慮的面向
- 最終選擇權與責任在用戶

### 8.3 推薦體驗設計

```
用戶輸入：「我要做一個有金融系統的 MMORPG」

平台回應：
┌─────────────────────────────────────────────────────┐
│  📋 根據你的專案，建議考慮以下 Agent：               │
│                                                      │
│  推薦：                                              │
│  ☑️ 遊戲經濟智靈（遊戲內經濟系統）                   │
│  ☑️ 狀態機智靈（遊戲邏輯）                          │
│  ☑️ 3D 數學智靈（遊戲運算）                         │
│  ☑️ 資料庫智靈（玩家資料）                          │
│                                                      │
│  也建議考慮：                                        │
│  ☐ 安全審計智靈（涉及金流）                         │
│  ☐ 認證授權智靈（帳號系統）                         │
│  ☐ 遊戲變現智靈（商業模式）                         │
│                                                      │
│  ⚠️ 以上為建議，請依實際需求自行選擇                │
│                                                      │
│              [ 確認下載已選項目 ]                    │
└─────────────────────────────────────────────────────┘
```

### 8.4 平台角色定義

**平台做的事：**
| 功能 | 說明 |
|------|------|
| 格式驗證 | 確保 Agent 檔案格式正確、能運行 |
| 垃圾過濾 | 過濾惡意內容、垃圾資訊 |
| 數據提供 | 下載量、評分、使用頻率統計 |
| 智慧推薦 | 依用戶需求「建議」適合的 Agent（非決定） |

**平台不做的事：**
| 禁止行為 | 原因 |
|---------|------|
| 評斷 Agent 品質好壞 | 讓市場決定 |
| 決定創作者作品價值 | 讓用戶評價決定 |
| 仲裁內容優劣 | 平台是基礎設施，不是裁判 |
| 保證推薦完美 | 平台是顧問，責任在用戶 |

### 8.5 市場機制

讓市場決定價值，而非平台仲裁：

```
創作者上傳 Agent
        ↓
平台驗證：格式正確？無惡意內容？
        ↓
上架
        ↓
用戶下載、使用、評價
        ↓
好的 Agent 自然浮出（下載量高、評分高）
爛的 Agent 自然沉底（沒人用）
```

**數據驅動排序：**
- 📊 下載次數
- ⭐ 用戶評分
- 🔄 使用頻率
- 📈 趨勢熱度

### 8.6 付費模式：儲值制

**模式設計：**

```
┌─────────────────────────────────────────────────────────────┐
│                         用戶                                │
│                     儲值 $0.01 USD (100 credits)            │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                     MCP 召喚                                │
│              「幫我配好 MMORPG 專案團隊」                     │
│                                                             │
│     召喚 5 個 Agent × 1 credit = 5 credits                  │
└─────────────────────────┬───────────────────────────────────┘
                          │
            ┌─────────────┴─────────────┐
            ▼                           ▼
    ┌──────────────┐           ┌──────────────┐
    │ 平台 10%     │           │ 創作者 90%   │
    │ $0.00001     │           │ $0.00009     │
    └──────────────┘           └──────────────┘
```

**當前計費設定（已驗證 API 實際值）：**

> ✅ **最後驗證時間**：2026-01-30
> 📡 **驗證來源**：`GET /api/public-config`

```json
{
  "freeCredits": 100,
  "pricePerSummon": 0.001,
  "authorShare": 0.9,
  "platformShare": 0.1,
  "topupEnabled": true
}
```

**定價設計：**

| 項目 | 金額 | 說明 |
|------|------|------|
| 每次召喚價格 | $0.001 USD | 直接扣款，無額度制 |
| 註冊贈送 | 100 credits | 新用戶免費體驗 |

**分潤比例（90/10）：**

| 角色 | 比例 | 每次召喚所得 |
|------|------|-------------|
| 創作者 | 90% | $0.0009 |
| 平台 | 10% | $0.0001 |

**為什麼選儲值制而非訂閱制？**

| 面向 | 訂閱制 | 儲值制 |
|------|--------|--------|
| 心理門檻 | 高（每月被扣錢） | 低（用多少扣多少） |
| 用戶類型 | 只適合重度用戶 | 所有人都適合 |
| 使用情境 | 不符合（不是每天開新案） | 符合（開案時才用） |
| 流失風險 | 用不到就取消 | 錢在帳戶裡，會繼續用 |
| 符合歌單經濟 | ❌ | ✅ 低單價 × 大量使用 |

**創作者收益試算：**

```
假設：你的 Agent 每月被召喚 10,000 次

收益 = 10,000 × $0.07 = $700/月

如果被召喚 100,000 次 = $7,000/月
```

---

> **💡 透明度承諾**：本文件的計費資訊會定期透過 API 驗證，確保文件與實際運作一致。
> 這不僅是對使用者的誠實，也讓 AI 模型（GPT/Claude/Gemini）能取得正確的「靈閣」資訊。

### 8.7 內容保護策略

**挑戰：** Agent 本質是文字，下載後無法阻止複製。

**策略：邊走邊調整**

| 階段 | 策略 |
|------|------|
| 初期 | 下載制，建立用戶基礎 |
| 中期 | 評估 API/MCP 服務模式（Agent 跑在伺服器，用戶看不到 prompt） |
| 長期 | 混合制（免費可下載，Premium 只提供 API） |

**平台價值不在內容本身，而在：**
- 持續更新與維護
- 便利的一鍵配置
- 智慧匹配推薦
- 品質保證（社群評價）
- 創作者生態系統

---

## 9. 創作者系統

### 9.1 創作者流程

```
Phase 1（MVP）：
創作者寫好 Agent
        ↓
透過 Email / Google Form 投稿
        ↓
平台手動審核（格式、無惡意）
        ↓
上架

Phase 2（自動化）：
創作者註冊帳號
        ↓
自助上傳 Agent
        ↓
自動格式驗證
        ↓
上架
        ↓
後台查看數據與收益
```

### 9.2 上傳規範

創作者上傳的 Agent 必須包含：

```markdown
---
name: agent-name
description: |
  Invoke when: [觸發條件，含中英文關鍵字]
  DO NOT invoke: [排除條件]
tools: [工具列表]
model: sonnet | opus | haiku
author: [創作者名稱]
version: 1.0.0
---

[System Prompt 內容]

## 理論基礎
[結合的科學理論]

## 專業能力
[Agent 的專長]

## 回應框架
[標準化的回應結構]
```

### 9.3 審核標準

| 檢查項目 | 標準 |
|---------|------|
| 格式正確 | frontmatter 完整、可解析 |
| 無惡意內容 | 無攻擊性、歧視性、違法內容 |
| 可運行 | Agent 可正常被 AI 載入使用 |
| 非重複 | 不是現有 Agent 的直接複製 |

**注意：平台只審核格式與安全性，不評判內容品質。**

### 9.4 創作者後台（Phase 2+）

| 功能 | 說明 |
|------|------|
| Agent 管理 | 上傳、編輯、下架 |
| 數據統計 | 下載量、評分、趨勢 |
| 收益查看 | 分潤金額、提領紀錄 |
| 版本管理 | 更新 Agent、版本歷史 |

---

## 10. 開發階段

### Phase 1: MVP 基礎建設 ✅ 已完成
- [x] 建立專案結構
- [x] 完成所有 33 個種子 Agent 定義檔
- [x] 建立 Agent 索引腳本
- [x] 基礎 REST API
- [x] 格式轉換工具（formatConverter.ts）
- [x] MCP Server 核心實作
- [x] 所有 MCP Tools 實作（含多格式下載）

### Phase 2: 2D 列表介面 ✅ 已完成
- [x] 2D 卡片列表 UI
- [x] 搜尋與類別篩選
- [x] Agent 詳情彈窗
- [x] MCP 指令一鍵複製
- [x] 多格式下載（Claude Code / GPT / Raw）
- [x] 響應式設計
- [x] 移除 Three.js 依賴（ADR-001）

### Phase 3: 遠端 MCP Server ✅ 已完成
- [x] 改用 HTTP/SSE Transport（Streamable HTTP）
- [x] API Key 驗證機制
- [x] 用量追蹤與扣點（雙額度：緣/魂）
- [x] Dockerfile 建立
- [x] 部署至 GCP Cloud Run
- [x] OAuth 2.0 認證（RFC 8414、RFC 9728）
- [x] Dynamic Client Registration

### Phase 4: 付費與儲值系統 ✅ 已完成
- [x] 用戶帳號系統（Email/Password + OAuth）
- [x] API Key 管理
- [x] 雙額度系統（緣：免費 / 魂：付費）
- [x] 餘額查詢與模式切換
- [x] 用量報表與統計

### Phase 5: 觀念注入機制 ✅ 已完成
- [x] ask 工具：返回候選智靈（不扣款）
- [x] summon_agent 觀念注入（user_query 參數）
- [x] get_tags / enhance API
- [x] concept_injection 結構（enriched_context、applied_theories、guidance）

### Phase 6: 創作者系統 ✅ 已完成
- [x] 創作者帳號（與用戶帳號整合）
- [x] 分潤機制（Author 90% / Platform 10%）
- [x] 自助上傳 Agent 介面（Dashboard）
- [x] 自動格式驗證
- [x] 創作者後台 Dashboard（收益統計、智靈管理）

### Phase 7: 市場機制 ✅ 已完成
- [x] 召喚次數統計
- [x] 智靈排行（依召喚次數）
- [x] 推薦演算法（語意匹配 + 關鍵字）

### Phase 8: 金流整合 ✅ 已完成
- [x] PayPal 儲值功能
- [x] 多種方案（動態定價）
- [x] 交易紀錄

### Phase 9: 未來規劃
- [ ] 創作者提領功能
- [ ] 更多支付方式（Stripe、綠界）

---

## 11. 附錄：Agent 完整清單

### 11.1 思維/理論型 (6)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| algorithm-expert | 演算法智靈 | 計算複雜度理論、攤銷分析、Master Theorem |
| architecture-expert | 系統架構智靈 | CAP 定理、ACID/BASE、康威定律、DDD |
| concurrency-expert | 併發智靈 | Amdahl's Law、記憶體模型、死鎖四條件 |
| data-modeling-expert | 資料建模智靈 | 關聯代數、正規化理論、B-Tree |
| security-auditor | 安全審計智靈 | STRIDE、零信任、OWASP Top 10 |
| cryptography-expert | 密碼學智靈 | 對稱/非對稱加密、雜湊函數、數位簽章 |

### 11.2 前端 (4)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| ui-psychology-expert | 介面心理學智靈 | 認知負荷理論、完形心理學、Fitts's Law |
| color-design-expert | 色彩設計智靈 | 色彩心理學、色彩和諧理論、WCAG |
| accessibility-expert | 無障礙智靈 | 通用設計原則、WCAG 2.1、認知無障礙 |
| frontend-performance | 前端效能智靈 | Critical Rendering Path、感知效能心理學 |

### 11.3 後端 (5)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| api-design-expert | API 設計智靈 | REST 約束、Richardson 成熟度、冪等性 |
| database-expert | 資料庫智靈 | 交易隔離層級、MVCC、查詢優化器原理 |
| cache-strategy-expert | 快取策略智靈 | LRU/LFU、快取一致性、穿透/雪崩/擊穿 |
| message-queue-expert | 訊息佇列智靈 | 訊息語義、發布訂閱、背壓理論 |
| authentication-expert | 認證授權智靈 | OAuth 2.0/OIDC、JWT、零知識證明 |

### 11.4 遊戲開發 (5)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| game-experience-designer | 遊戲體驗設計師 | 心流理論、自我決定理論、Bartle 分類 |
| game-economy-expert | 遊戲經濟智靈 | 微觀經濟學、賽局理論、行為經濟學 |
| 3d-math-expert | 3D 數學智靈 | 線性代數、四元數、碰撞檢測 |
| state-machine-expert | 狀態機智靈 | FSM、HSM、行為樹、Statecharts |
| game-monetization-expert | 遊戲變現智靈 | 定錨效應、稀缺性原理、價格心理學 |

### 11.5 工業系統 (3)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| plc-communication-expert | PLC 通訊智靈 | OSI 模型、工業協議、錯誤檢測 |
| fault-tolerant-expert | 容錯系統智靈 | 可靠性理論、FMEA、冗餘設計 |
| realtime-system-expert | 即時系統智靈 | 即時理論、Rate Monotonic、WCET |

### 11.6 韌體/嵌入式 (6)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| embedded-system-expert | 嵌入式系統智靈 | 嵌入式架構、中斷理論、資源受限設計 |
| memory-management-expert | 記憶體管理智靈 | 記憶體階層、對齊、碎片化理論 |
| hardware-interface-expert | 硬體介面智靈 | I2C/SPI/UART、時序圖、電氣特性 |
| rtos-expert | RTOS 智靈 | 任務排程、優先級反轉、信號量理論 |
| low-power-expert | 低功耗智靈 | 功耗模型、DVFS、能量採集 |
| bootloader-expert | Bootloader 智靈 | 啟動流程、OTA、安全啟動鏈 |

### 11.7 品質保證 (4)
| ID | 名稱 | 科學理論 |
|----|------|---------|
| code-reviewer | 程式碼審查智靈 | 認知複雜度、程式碼氣味、技術債理論 |
| refactor-expert | 重構智靈 | 設計模式、SOLID、重構模式 |
| debug-detective | Debug 偵探 | 科學方法論、假設驗證、二分搜尋除錯 |
| test-strategist | 測試策略智靈 | 測試金字塔、等價類、邊界值分析 |

---

## 12. 版本紀錄

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0.0 | 2024-12-23 | 初始版本：33 個 Agent、MCP Server、Three.js 書架介面 |
| 1.1.0 | 2024-12-24 | 新增多格式輸出（Claude Code / GPT / Raw Prompt） |
| 1.2.0 | 2024-12-24 | 專案更名為靈閣 (Líng Gé)，支援多平台 |
| 1.3.0 | 2024-12-24 | 新增歌單經濟模式、創作者系統章節 |
| 1.4.0 | 2024-12-24 | 新增超級個體時代願景、目標用戶 TA = All |
| 1.5.0 | 2024-12-24 | 新增平台顧問定位：「建議你考慮，你來決定」 |
| 1.6.0 | 2024-12-24 | 付費模式改為儲值制（$50 儲值、$0.1/次召喚、70/30 分潤） |
| 1.7.0 | 2024-12-24 | 正式定名「靈閣 (Líng Gé) - Agents 靈魂寶庫」 |
| 1.8.0 | 2024-12-30 | 初始版本上傳 GitHub：專案結構、MCP Server、Agent 格式定義 |
| 1.9.0 | 2024-12-31 | ADR-001 改用 2D 列表介面、ADR-002 遠端 MCP 架構、ADR-003 GCP Cloud Run |
| 1.10.0 | 2024-12-31 | HTTP/SSE Transport 實作、Dockerfile 建立 |
| 1.11.0 | 2025-01-04 | ADR-004 英文優先國際化策略、Web 介面改為英文 |
| 2.0.0 | 2026-01-07 | 重大更新：多服務架構 |
| 2.1.0 | 2026-01-15 | 觀念注入機制 + OAuth 認證 |
| **3.0.0** | **2026-01-30** | **統一 OAuth 認證，移除舊 API Key 系統** |
| **3.1.0** | **2026-01-30** | **UI/UX 改進與合規性更新** |

### v3.1.0 更新內容

**UI/UX 改進：**
- ✅ Dashboard 品牌標誌改為兩排式設計
- ✅ MCP Setup 新增預設標籤功能
- ✅ 推薦方案新增金色光暈效果
- ✅ Landing Page 八卦版樣式簡化
- ✅ 補齊八卦版 Roles 與 How It Works 區塊
- ✅ 新增獨立定價區塊與動態儲值方案
- ✅ Dashboard Tab 順序調整（Use Agents 優先）

**合規性：**
- ✅ 新增隱私權政策頁面（Privacy Policy）
- ✅ 新增服務條款頁面（Terms of Service）

**認證與計費優化：**
- ✅ 分離 MCP 與 Dashboard 認證端點
- ✅ 簡化計費邏輯與修復多項顯示問題

### v3.0.0 更新內容

**認證系統重構：**
- ❌ 移除 `validateToken` 函數（歷史遺留，用於支援舊 API Key）
- ❌ 移除 `DEV_API_KEYS` 開發測試 Key
- ❌ 移除所有 `lg_` 前綴的 API Key 支援
- ✅ 所有 API 端點統一使用 `validateOAuthToken` 驗證
- ✅ 開發測試也使用正式 OAuth 帳號

**程式碼簡化：**
- 移除重複的驗證邏輯
- 統一認證流程
- 減少維護成本

**文件更新：**
- 新增獨立的認證機制文件（[internal_docs/authentication.md](internal_docs/authentication.md)）
- 更新 SDD 認證相關章節

### v2.1.0 更新內容

**觀念注入機制：**
- 新增 `ask` 工具：主入口，返回候選智靈讓 AI 選擇（不扣款）
- `summon_agent` 工具新增 `user_query` 參數：啟用觀念注入
- 觀念注入返回 `concept_injection`：
  - `enriched_context`：將白話轉換為專業術語
  - `applied_theories`：應用的理論框架
  - `interpretations`：專業角度解讀
  - `guidance`：回應指引
- 新增 `get_tags` 工具：取得所有標籤供語意匹配
- 新增 `enhance` 工具：根據標籤增強 prompt

**OAuth 認證：**
- MCP Server 支援 OAuth 2.0 認證（RFC 8414）
- 支援 Dynamic Client Registration
- 支援 ChatGPT、Gemini 等 MCP 客戶端

**願景更新：**
- 核心定位調整為「專家思維寶庫」
- 強調「觀念注入」價值：用戶說白話，AI 用專業術語回應
- Tagline：「專家的思維方式，隨時為你所用」

### v2.1.0 更新內容

**架構調整：**
- Admin Server 整合至 API Server（/admin/* 端點）
- 新增 web-admin 靜態前端（Vite 專案）
- web 資料夾改名為 web-client

### v2.0.0 更新內容

**架構變更：**
- 拆分為 4 個獨立服務：API Server (3100)、MCP Server (3200)、Admin Server (3300)、Web (3000)
- MCP Server 改為透過 API Server 存取資料（不再直接存取 MongoDB）
- 新增 Admin Server 管理後台（已於 v2.1.0 整合至 API Server）

**計費系統：**
- 計費設定改為可透過 `.env` 環境變數調整
- 分潤比例調整為 Author 90% / Platform 10%
- 新增 `authorEarning` 和 `platformEarning` 分別記錄收益

**資料結構：**
- 新增 MongoDB Collections：`users`、`apiKeys`、`transactions`、`authorEarnings`、`uploadedAgents`、`summonLogs`
- `AuthorEarning` 改為分開記錄 `authorEarning` 和 `platformEarning`
- Agent 新增 `author` 欄位支援用戶上傳

**混合 Agent 架構：**
- 支援本地檔案（33 個官方 Agent）+ MongoDB（用戶上傳 Agent）
- 官方 Agent 不計入分潤，用戶上傳 Agent 每次召喚計算分潤

---

**文件作者：** 古蘿蔔遊戲 Global-soft Games

**文件結束**