# OAuth 認證流程說明

靈閣使用 **OAuth 2.0** 標準協議進行身份認證，確保你的帳號安全。

---

## 什麼是 OAuth？

OAuth 2.0 是業界標準的授權協議，讓你可以安全地授權第三方應用（如 ChatGPT、Claude Code）存取你的靈閣帳號，**而不需要洩漏密碼**。

### 日常生活中的 OAuth 範例

你可能已經在使用 OAuth 而不自知：

- 「使用 Google 帳號登入」→ OAuth
- 「使用 Facebook 帳號登入」→ OAuth
- 「授權 App 存取你的相簿」→ OAuth

靈閣的 OAuth 流程與這些服務完全相同。

---

## 為什麼使用 OAuth？

### ✅ 安全優勢

| 傳統方式 | OAuth 方式 |
|---------|-----------|
| ❌ 把靈閣密碼給 ChatGPT | ✅ 不需要洩漏密碼 |
| ❌ ChatGPT 可以修改你的密碼 | ✅ ChatGPT 只能存取授權功能 |
| ❌ 無法撤銷授權 | ✅ 隨時可以取消授權 |
| ❌ 密碼洩漏風險 | ✅ Token 加密儲存且定期過期 |

### 🔒 靈閣的安全設計

1. **TOTP 雙重認證**：除了密碼，還需要驗證器產生的 6 位數驗證碼
2. **Token 加密儲存**：OAuth Token 使用業界標準加密演算法儲存
3. **HTTPS 全程加密**：所有通訊透過 HTTPS 加密傳輸
4. **定期過期機制**：Token 會定期過期，需要重新授權

---

## OAuth 流程圖（概念層級）

```
┌─────────────┐                  ┌─────────────┐                  ┌─────────────┐
│   ChatGPT   │                  │   靈閣      │                  │   使用者    │
│   /Claude   │                  │   Server    │                  │             │
└──────┬──────┘                  └──────┬──────┘                  └──────┬──────┘
       │                                │                                │
       │  1. 請求授權 (Authorization)    │                                │
       ├───────────────────────────────>│                                │
       │                                │                                │
       │  2. 重導向到授權頁面            │                                │
       │<───────────────────────────────┤                                │
       │                                │                                │
       │  3. 在瀏覽器中開啟授權頁面                                        │
       ├─────────────────────────────────────────────────────────────────>│
       │                                │                                │
       │                                │  4. 登入 (Email + TOTP)         │
       │                                │<───────────────────────────────┤
       │                                │                                │
       │                                │  5. 確認授權範圍                │
       │                                │<───────────────────────────────┤
       │                                │                                │
       │  6. 授權碼 (Authorization Code) │                                │
       │<───────────────────────────────┤                                │
       │                                │                                │
       │  7. 用授權碼換取 Access Token    │                                │
       ├───────────────────────────────>│                                │
       │                                │                                │
       │  8. 回傳 Access Token           │                                │
       │<───────────────────────────────┤                                │
       │                                │                                │
       │  9. 使用 Token 呼叫 API         │                                │
       ├───────────────────────────────>│                                │
       │                                │                                │
       │  10. 回傳智靈資訊               │                                │
       │<───────────────────────────────┤                                │
       │                                │                                │
```

### 流程說明

1. **ChatGPT/Claude 請求授權**：當你第一次設定 MCP 連線時觸發
2. **重導向到授權頁面**：靈閣回傳授權頁面 URL
3. **使用者登入**：在瀏覽器中輸入 Email 和 TOTP 驗證碼
4. **確認授權範圍**：查看 ChatGPT/Claude 想要存取的權限（如召喚智靈、查看額度）
5. **產生授權碼**：靈閣產生一次性的授權碼
6. **換取 Access Token**：ChatGPT/Claude 用授權碼換取長期使用的 Token
7. **使用 Token 存取服務**：之後每次呼叫靈閣 API 都會帶上這個 Token

---

## 授權範圍

當你授權 ChatGPT/Claude 存取靈閣時，你授予的權限包括：

| 權限 | 說明 |
|------|------|
| `agents:list` | 列出可用的智靈 |
| `agents:get` | 取得特定智靈資訊 |
| `agents:summon` | 召喚智靈（會消耗額度）|
| `user:credits` | 查看你的額度餘額 |

> ⚠️ **不包括的權限**：
> - 修改密碼
> - 儲值/付款
> - 刪除帳號
> - 上傳/刪除智靈
> - 修改 PayPal 設定

---

## Token 生命週期

### Access Token

- **有效期限**：30 天
- **用途**：存取靈閣 API
- **儲存位置**：ChatGPT/Claude 本地加密儲存
- **過期處理**：自動使用 Refresh Token 更新

### Refresh Token

- **有效期限**：90 天
- **用途**：更新 Access Token
- **儲存位置**：ChatGPT/Claude 本地加密儲存
- **過期處理**：需要重新完成 OAuth 授權流程

---

## 如何管理授權

### 查看已授權的應用

1. 登入 [https://lingge.app](https://lingge.app)
2. 前往 **Dashboard** → **MCP 設定**
3. 查看「已連結帳號」區塊

你會看到所有已授權的應用，例如：

```
✅ ChatGPT Desktop
   授權時間：2026-01-30 10:30:15
   [解除連結]

✅ Claude Code
   授權時間：2026-01-28 14:22:03
   [解除連結]
```

### 撤銷授權

點擊「解除連結」按鈕，該應用將立即失去存取權限。

> 💡 **提示**：解除連結後，該應用下次使用時會要求重新授權。

---

## 安全最佳實踐

### ✅ 建議做法

1. **定期檢查授權**：每個月檢查一次「已連結帳號」，撤銷不使用的授權
2. **啟用 TOTP**：務必設定 TOTP 雙重認證
3. **不共享帳號**：每個人使用自己的靈閣帳號
4. **注意授權範圍**：授權前仔細查看應用要求的權限

### ❌ 避免做法

1. **不要洩漏 Token**：不要把 Access Token 貼在公開論壇或分享給他人
2. **不要停用 TOTP**：雙重認證是帳號安全的關鍵
3. **不要使用公共電腦授權**：避免在網咖等公共場所完成 OAuth 授權

---

## 技術細節（給開發者）

### OAuth 2.0 Flow

靈閣使用 **Authorization Code Flow**，符合 RFC 6749 標準。

### Endpoints

| Endpoint | URL | 說明 |
|----------|-----|------|
| Authorization | `https://api.lingge.app/oauth/authorize` | 授權頁面 |
| Token | `https://api.lingge.app/oauth/token` | 換取 Token |
| Revoke | `https://api.lingge.app/oauth/revoke` | 撤銷 Token |

> ⚠️ **注意**：這些 URL 僅供說明，實際整合請使用 MCP 協議自動處理。

### Token 格式

Access Token 使用 **JWT (JSON Web Token)** 格式，包含：

- `sub`：使用者 ID
- `scope`：授權範圍
- `exp`：過期時間
- `iat`：簽發時間

> 🔒 **Token 簽名**：使用 RS256 演算法簽名，私鑰由靈閣安全儲存。

---

## 常見問題

### Q: OAuth 授權後，ChatGPT 能看到我的密碼嗎？

**不能。** OAuth 的核心設計就是避免洩漏密碼。ChatGPT 只會收到一個 Access Token，這個 Token：

- 只能存取你授權的功能（如召喚智靈）
- 無法修改你的密碼
- 會定期過期
- 你可以隨時撤銷

### Q: 如果 Token 洩漏了怎麼辦？

1. 立即前往 Dashboard → MCP 設定
2. 點擊「解除連結」撤銷該應用的授權
3. Token 會立即失效，無法再被使用
4. 如有必要，可以修改密碼並重新設定 TOTP

### Q: 為什麼要定期重新授權？

Token 定期過期是安全設計的一部分：

- 降低 Token 被盜用的風險
- 確保你仍然同意該應用的授權
- 符合業界安全標準

### Q: OAuth 和 API Key 有什麼不同？

| OAuth Token | API Key |
|------------|---------|
| ✅ 可撤銷 | ❌ 無法撤銷（除非刪除） |
| ✅ 定期過期 | ❌ 長期有效 |
| ✅ 範圍限制 | ❌ 通常有完整權限 |
| ✅ 使用者授權 | ❌ 開發者產生 |

靈閣採用 OAuth 是為了更好的安全性與使用者體驗。

---

## 延伸閱讀

- 📖 [MCP 連線設定教學](./MCP_SETUP.md)
- ❓ [常見問題 FAQ](./FAQ.md)
- 🚀 [快速開始指南](./GETTING_STARTED.md)
- 🔗 [OAuth 2.0 RFC 6749](https://datatracker.ietf.org/doc/html/rfc6749) (官方規範)

---

## 需要協助？

- 📧 Email: support@lingge.app
- 🌐 官網: [https://lingge.app](https://lingge.app)

---

> **靈閣 (Líng Gé)** - 借他山之石，攻你心中玉
>
> © 2026 古蘿蔔遊戲 Global-soft Games
